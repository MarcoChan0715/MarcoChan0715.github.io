<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Subscription Manager App</title>

  <link rel="stylesheet" href="Coursework.css" />

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    /* ===== App Specific Styles ===== */
    #sm {
      box-sizing: border-box;
      font-family: 'Poppins', sans-serif;
      width: 100%;
      padding: 24px 16px 56px;
      background: rgba(255, 255, 255, 0.95); 
      border-radius: 16px;
      transition: background 0.3s, color 0.3s;
    }

    .app-container { max-width: 1100px; margin: 0 auto; }

    /* Default Light Mode Variables */
    :root { --ink: #0f172a; --muted:#64748b; --card:#ffffff; --border:#e5e7eb; }
    
    /* GLOBAL DARK MODE OVERRIDES */
    /* When <body> has class 'dark-mode', update the app variables */
    body.dark-mode #sm {
        background: rgba(30, 30, 40, 0.95);
        --ink: #eef2ff;
        --muted: #94a3b8;
        --card: #1e293b;
        --border: #334155;
    }

    /* Layout Utilities */
    #sm h1 { margin: 0 0 12px; font-size: 26px; font-weight:700; color: var(--ink); }
    #sm p.sm-sub { margin:0; color: var(--muted); font-size:12px; }
    #sm .sm-top { display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap; margin:14px 0 18px; }
    #sm .sm-group { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    
    /* Inputs & Cards */
    #sm .sm-input, #sm .sm-select {
      background: var(--card); color: var(--ink);
      border:1px solid var(--border); border-radius:12px; padding:10px 12px; font-size:14px;
      outline:none; min-height:40px; width: 100%;
    }
    #sm .sm-card { background: var(--card); border:1px solid var(--border); border-radius:16px; padding:16px; margin-bottom: 20px; box-shadow:0 8px 18px rgba(0,0,0,0.06); }
    
    /* Grid System */
    #sm .sm-row { display:grid; grid-template-columns: repeat(12, 1fr); gap:10px; margin-top: 10px; }
    #sm .col-12 { grid-column: span 12; }
    #sm .col-6 { grid-column: span 6; }
    #sm .col-3 { grid-column: span 3; }
    #sm .sm-btn { border:1px solid var(--border); background: var(--card); color: var(--ink); border-radius:12px; padding:10px 14px; font-weight:600; cursor:pointer; }
    #sm .sm-btn.primary { background: linear-gradient(90deg, #ec4899, #06b6d4); color:#fff; border:0; }
    #sm .fx-grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap:10px; margin-bottom: 10px; }

    @media (max-width: 800px) { 
        #sm .col-6, #sm .col-3 { grid-column: span 12; } 
    }
  </style>
</head>
<body>

  <div class="header-container">
     <a href="index.html">
        <img src="images/Coursework/Untitled_Artwork.png" class="logo" alt="Logo">
     </a>
     <div class="navbar">
      <ul>
        <li><a href="index.html">Home</a></li>
        <li><a href="Hobbies.html">Hobbies</a></li>
        <li><a href="Video.html">Video</a></li>
        <li><a href="app.html">App</a></li>
        <li><a href="Clock.html">Clock</a></li>
      </ul>
     </div>
  </div>

  <main class="main-content-spacer" style="padding-top: 160px;"> 
    <div id="sm">
      <div class="sm-top">
        <div>
          <h1>Subscription Manager</h1>
          <p class="sm-sub">Track your recurring payments easily.</p>
        </div>
        <div class="sm-group">
          <label class="sm-label" style="font-size: 12px; color: var(--muted)">Currency:</label>
          <select id="displayCcy" class="sm-select" style="width:auto;"></select>
        </div>
      </div>
      
      <div class="sm-card" style="display:flex; gap:20px; justify-content: space-around; text-align: center;">
        <div>
            <div style="font-size:12px; color:var(--muted);">Monthly Total</div>
            <div id="totMonthly" style="font-size:24px; font-weight:700; color:var(--ink);">$0.00</div>
        </div>
        <div>
            <div style="font-size:12px; color:var(--muted);">Yearly Total</div>
            <div id="totYearly" style="font-size:24px; font-weight:700; color:var(--ink);">$0.00</div>
        </div>
      </div>

      <section class="sm-card">
        <h3 style="color:var(--ink)">Add Subscription</h3>
        <div class="sm-row">
          <div class="col-6"><input id="name" class="sm-input" placeholder="Name (e.g. Netflix)" /></div>
          <div class="col-3"><input id="cost" type="number" class="sm-input" placeholder="Price" /></div>
          <div class="col-3"><select id="currency" class="sm-select"></select></div>
          <div class="col-6">
            <select id="cycle" class="sm-select">
              <option value="monthly">Monthly</option>
              <option value="yearly">Yearly</option>
            </select>
          </div>
           <div class="col-6"><input id="startDate" type="date" class="sm-input" /></div>
        </div>
        <button id="addBtn" class="sm-btn primary" style="margin-top: 15px; width: 100%;">+ Add Subscription</button>
      </section>

      <section class="sm-card">
        <h3 style="color:var(--ink)">Active Subscriptions (<span id="countActive">0</span>)</h3>
        <div id="activeList"></div>
      </section>
      
      <section class="sm-card">
        <h3 style="color:var(--ink)">FX Rates</h3>
         <div id="fxGrid" class="fx-grid"></div>
         <button id="fxUpdate" class="sm-btn">Update Rates</button>
      </section>

    </div>
  </main>

  <script src="Coursework.js"></script>

  <script>
  (function(){
    const $ = (id) => document.getElementById(id);
    const K_SUBS = 'sm:subs:v2';
    
    // Default fallback rates (in case internet is down)
    let DEFAULT_FX = { USD:1, GBP:0.77, EUR:0.92, HKD:7.8, JPY:157, CAD:1.36, AUD:1.52, CNY:7.23 };
    
    let subs = JSON.parse(localStorage.getItem(K_SUBS) || '[]');
    let fx = DEFAULT_FX; // Starts with default, updates later
    let display = 'USD';

    function save(){ localStorage.setItem(K_SUBS, JSON.stringify(subs)); }
    
    function fmtMoney(n, ccy){ 
        return new Intl.NumberFormat('en-US', { style: 'currency', currency: ccy }).format(n);
    }

    function convert(amount, src, dest){ 
        const s = fx[src] || 1; 
        const d = fx[dest] || 1; 
        return (amount / s) * d; 
    }

    // --- NEW: Fetch Real-Time Rates ---
    async function fetchLiveRates() {
        const btn = $('fxUpdate');
        const originalText = btn.textContent;
        btn.textContent = "Fetching Live Rates...";
        btn.disabled = true;

        try {
            // Using Frankfurter API (Free, Open Source, No API Key needed)
            const response = await fetch('https://api.frankfurter.app/latest?from=USD');
            if (!response.ok) throw new Error("API Connection Failed");
            
            const data = await response.json();
            
            // API returns rates relative to USD. We merge USD:1 back in.
            fx = { USD: 1, ...data.rates };
            
            render(); // Refresh the UI with new data
            btn.textContent = "Rates Updated!";
        } catch (error) {
            console.error("Could not fetch rates:", error);
            alert("Could not connect to live currency server. Using offline default rates.");
            fx = DEFAULT_FX;
            render();
            btn.textContent = "Update Failed (Offline)";
        } finally {
            // Reset button after 2 seconds
            setTimeout(() => { 
                btn.textContent = originalText; 
                btn.disabled = false; 
            }, 2000);
        }
    }

    function render(){
        // 1. Render Subscriptions List
        const list = $('activeList');
        list.innerHTML = '';
        let mTotal = 0;
        let yTotal = 0;

        subs.forEach((s, index) => {
            // Convert cost to the selected Display Currency
            const val = convert(s.cost, s.currency, display);
            
            // Calculate Totals
            if(s.cycle === 'monthly') { mTotal += val; yTotal += val * 12; }
            else { mTotal += val / 12; yTotal += val; }

            // Create List Item
            const div = document.createElement('div');
            div.style.cssText = "display:flex; justify-content:space-between; padding: 10px; border-bottom:1px solid var(--border); color: var(--ink); align-items: center;";
            div.innerHTML = `
                <div>
                    <strong>${s.name}</strong> 
                    <span style="font-size:12px; background:#eee; color:#555; padding:2px 6px; border-radius:4px; margin-left:8px;">${s.cycle}</span>
                    <br> 
                    <small style="color:var(--muted)">Original: ${s.cost} ${s.currency}</small>
                </div>
                <div style="text-align:right;">
                    <div style="font-weight:bold; font-size:16px;">${fmtMoney(val, display)}</div>
                    <button onclick="window.delSub(${index})" style="color:#ef4444; font-size:12px; border:none; background:none; cursor:pointer; margin-top:4px;">Remove</button>
                </div>
            `;
            list.appendChild(div);
        });

        // 2. Update Header Totals
        $('totMonthly').innerText = fmtMoney(mTotal, display);
        $('totYearly').innerText = fmtMoney(yTotal, display);
        $('countActive').innerText = subs.length;
        
        // 3. Populate Dropdowns (Dynamic based on fetched rates)
        // We save the current selection so it doesn't reset every time we render
        const curSel = $('currency').value;
        const disSel = $('displayCcy').value;

        const opts = Object.keys(fx).sort().map(c => `<option value="${c}">${c}</option>`).join('');
        $('currency').innerHTML = opts;
        $('displayCcy').innerHTML = opts;
        
        // Restore selections if valid
        if(fx[curSel]) $('currency').value = curSel;
        if(fx[disSel]) $('displayCcy').value = disSel; else $('displayCcy').value = 'USD';

        // 4. Render FX Grid (The new currency box display)
        const grid = $('fxGrid');
        grid.innerHTML = '';
        Object.keys(fx).forEach(ccy => {
            if(ccy === 'USD') return; // Skip base
            const rate = fx[ccy];
            // Show rate relative to USD
            const item = document.createElement('div');
            item.className = 'fx-item';
            item.innerHTML = `
                <div style="font-weight:bold; color:var(--ink);">${ccy}</div> 
                <div style="color:var(--muted); font-size:13px;">${rate.toFixed(2)}</div>
            `;
            grid.appendChild(item);
        });
    }

    // Event Listeners
    $('addBtn').addEventListener('click', () => {
        const name = $('name').value;
        const cost = parseFloat($('cost').value);
        if(!name || !cost) return alert('Please enter name and cost');
        
        subs.push({
            name, 
            cost, 
            currency: $('currency').value, 
            cycle: $('cycle').value,
            date: $('startDate').value
        });
        save();
        render();
        $('name').value = ''; $('cost').value = '';
    });

    $('displayCcy').addEventListener('change', (e) => { display = e.target.value; render(); });
    $('fxUpdate').addEventListener('click', fetchLiveRates);

    window.delSub = function(index) {
        if(confirm('Delete this subscription?')) {
            subs.splice(index, 1);
            save();
            render();
        }
    };

    // Initial Load
    render(); // Show existing data first
    fetchLiveRates(); // Then fetch real data immediately
  })();
  </script>
</body>
</html>
