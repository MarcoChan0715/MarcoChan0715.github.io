<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Subscription Manager App</title>

  <link rel="stylesheet" href="Coursework.css" />

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    /* ===== App Specific Styles ===== */
    #sm {
      box-sizing: border-box;
      font-family: 'Poppins', sans-serif;
      width: 100%;
      padding: 24px 16px 56px;
      background: rgba(255, 255, 255, 0.95); 
      border-radius: 16px;
      transition: background 0.3s, color 0.3s;
    }

    .app-container { max-width: 1100px; margin: 0 auto; }

    /* Default Light Mode Variables */
    :root { --ink: #0f172a; --muted:#64748b; --card:#ffffff; --border:#e5e7eb; }
    
    /* GLOBAL DARK MODE OVERRIDES */
    /* When <body> has class 'dark-mode', update the app variables */
    body.dark-mode #sm {
        background: rgba(30, 30, 40, 0.95);
        --ink: #eef2ff;
        --muted: #94a3b8;
        --card: #1e293b;
        --border: #334155;
    }

    /* Layout Utilities */
    #sm h1 { margin: 0 0 12px; font-size: 26px; font-weight:700; color: var(--ink); }
    #sm p.sm-sub { margin:0; color: var(--muted); font-size:12px; }
    #sm .sm-top { display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap; margin:14px 0 18px; }
    #sm .sm-group { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    
    /* Inputs & Cards */
    #sm .sm-input, #sm .sm-select {
      background: var(--card); color: var(--ink);
      border:1px solid var(--border); border-radius:12px; padding:10px 12px; font-size:14px;
      outline:none; min-height:40px; width: 100%;
    }
    #sm .sm-card { background: var(--card); border:1px solid var(--border); border-radius:16px; padding:16px; margin-bottom: 20px; box-shadow:0 8px 18px rgba(0,0,0,0.06); }
    
    /* Grid System */
    #sm .sm-row { display:grid; grid-template-columns: repeat(12, 1fr); gap:10px; margin-top: 10px; }
    #sm .col-12 { grid-column: span 12; }
    #sm .col-6 { grid-column: span 6; }
    #sm .col-3 { grid-column: span 3; }
    #sm .sm-btn { border:1px solid var(--border); background: var(--card); color: var(--ink); border-radius:12px; padding:10px 14px; font-weight:600; cursor:pointer; }
    #sm .sm-btn.primary { background: linear-gradient(90deg, #ec4899, #06b6d4); color:#fff; border:0; }
    #sm .fx-grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap:10px; margin-bottom: 10px; }

    @media (max-width: 800px) { 
        #sm .col-6, #sm .col-3 { grid-column: span 12; } 
    }
  </style>
</head>
<body>

  <div class="header-container">
     <a href="index.html">
        <img src="images/Coursework/Untitled_Artwork.png" class="logo" alt="Logo">
     </a>
     <div class="navbar">
      <ul>
        <li><a href="index.html">Home</a></li>
        <li><a href="Hobbies.html">Hobbies</a></li>
        <li><a href="Video.html">Video</a></li>
        <li><a href="app.html">App</a></li>
        <li><a href="Clock.html">Clock</a></li>
      </ul>
     </div>
  </div>

  <main class="main-content-spacer" style="padding-top: 160px;"> 
    <div id="sm">
      <div class="sm-top">
        <div>
          <h1>Subscription Manager</h1>
          <p class="sm-sub">Track your recurring payments easily.</p>
        </div>
        <div class="sm-group">
          <label class="sm-label" style="font-size: 12px; color: var(--muted)">Currency:</label>
          <select id="displayCcy" class="sm-select" style="width:auto;"></select>
        </div>
      </div>
      
      <div class="sm-card" style="display:flex; gap:20px; justify-content: space-around; text-align: center;">
        <div>
            <div style="font-size:12px; color:var(--muted);">Monthly Total</div>
            <div id="totMonthly" style="font-size:24px; font-weight:700; color:var(--ink);">$0.00</div>
        </div>
        <div>
            <div style="font-size:12px; color:var(--muted);">Yearly Total</div>
            <div id="totYearly" style="font-size:24px; font-weight:700; color:var(--ink);">$0.00</div>
        </div>
      </div>

      <section class="sm-card">
        <h3 style="color:var(--ink)">Add Subscription</h3>
        <div class="sm-row">
          <div class="col-6"><input id="name" class="sm-input" placeholder="Name (e.g. Netflix)" /></div>
          <div class="col-3"><input id="cost" type="number" class="sm-input" placeholder="Price" /></div>
          <div class="col-3"><select id="currency" class="sm-select"></select></div>
          <div class="col-6">
            <select id="cycle" class="sm-select">
              <option value="monthly">Monthly</option>
              <option value="yearly">Yearly</option>
            </select>
          </div>
           <div class="col-6"><input id="startDate" type="date" class="sm-input" /></div>
        </div>
        <button id="addBtn" class="sm-btn primary" style="margin-top: 15px; width: 100%;">+ Add Subscription</button>
      </section>

      <section class="sm-card">
        <h3 style="color:var(--ink)">Active Subscriptions (<span id="countActive">0</span>)</h3>
        <div id="activeList"></div>
      </section>
      
      <section class="sm-card">
        <h3 style="color:var(--ink)">Rates</h3>
         <div id="fxGrid" class="fx-grid"></div>
         <button id="fxUpdate" class="sm-btn">Update Rates</button>
      </section>

    </div>
  </main>

  <script src="Coursework.js"></script>

  <script>
  (function(){
    const $ = (id) => document.getElementById(id);
    const K_SUBS = 'sm:subs:v2';
    
    // Default fallback rates
    let DEFAULT_FX = { USD:1, GBP:0.77, EUR:0.92, HKD:7.8, JPY:157, CAD:1.36, AUD:1.52, CNY:7.23 };
    
    let subs = JSON.parse(localStorage.getItem(K_SUBS) || '[]');
    let fx = DEFAULT_FX;
    let display = 'USD';
    let editIndex = -1; // Tracks which item is being edited (-1 means none)

    function save(){ localStorage.setItem(K_SUBS, JSON.stringify(subs)); }
    
    function fmtMoney(n, ccy){ 
        return new Intl.NumberFormat('en-US', { style: 'currency', currency: ccy }).format(n);
    }

    function convert(amount, src, dest){ 
        const s = fx[src] || 1; 
        const d = fx[dest] || 1; 
        return (amount / s) * d; 
    }

    // --- Fetch Real-Time Rates ---
    async function fetchLiveRates() {
        const btn = $('fxUpdate');
        const originalText = btn.textContent;
        btn.textContent = "Fetching...";
        btn.disabled = true;

        try {
            const response = await fetch('https://api.frankfurter.app/latest?from=USD');
            if (!response.ok) throw new Error("API Connection Failed");
            const data = await response.json();
            fx = { USD: 1, ...data.rates };
            render(); 
            btn.textContent = "Rates Updated!";
        } catch (error) {
            console.error(error);
            alert("Using offline rates.");
            fx = DEFAULT_FX;
            render();
            btn.textContent = "Update Failed";
        } finally {
            setTimeout(() => { btn.textContent = originalText; btn.disabled = false; }, 2000);
        }
    }

    function render(){
        const list = $('activeList');
        list.innerHTML = '';
        let mTotal = 0;
        let yTotal = 0;

        subs.forEach((s, index) => {
            // Ensure 'active' property exists (default to true)
            if (typeof s.active === 'undefined') s.active = true;

            // Only add to TOTAL if active
            const val = convert(s.cost, s.currency, display);
            if (s.active) {
                if(s.cycle === 'monthly') { mTotal += val; yTotal += val * 12; }
                else { mTotal += val / 12; yTotal += val; }
            }

            // Create List Item
            const div = document.createElement('div');
            // Dim the card if inactive
            const opacity = s.active ? "1" : "0.5";
            const bg = s.active ? "transparent" : "rgba(0,0,0,0.02)";
            
            div.style.cssText = `display:flex; justify-content:space-between; padding: 12px; border-bottom:1px solid var(--border); color: var(--ink); align-items: center; opacity:${opacity}; background:${bg};`;
            
            div.innerHTML = `
                <div>
                    <strong>${s.name}</strong> 
                    <span style="font-size:11px; background:${s.active ? '#e0f2fe' : '#ddd'}; color:${s.active ? '#0284c7' : '#666'}; padding:2px 6px; border-radius:4px; margin-left:6px; font-weight:600;">
                        ${s.active ? s.cycle : 'PAUSED'}
                    </span>
                    <br> 
                    <small style="color:var(--muted)">Original: ${s.cost} ${s.currency}</small>
                </div>
                <div style="text-align:right; display:flex; flex-direction:column; align-items:flex-end; gap:5px;">
                    <div style="font-weight:bold; font-size:16px;">${fmtMoney(val, display)}</div>
                    
                    <div style="display:flex; gap:8px;">
                        <button onclick="window.toggleSub(${index})" style="font-size:12px; border:1px solid var(--border); background:var(--card); color:var(--ink); padding:4px 8px; border-radius:6px; cursor:pointer;" title="Pause/Resume">
                            ${s.active ? '‚è∏Ô∏è' : '‚ñ∂Ô∏è'}
                        </button>

                        <button onclick="window.editSub(${index})" style="font-size:12px; border:1px solid var(--border); background:var(--card); color:var(--ink); padding:4px 8px; border-radius:6px; cursor:pointer;" title="Edit">
                            ‚úèÔ∏è
                        </button>
                        
                        <button onclick="window.delSub(${index})" style="font-size:12px; border:1px solid #fee2e2; background:#fef2f2; color:#ef4444; padding:4px 8px; border-radius:6px; cursor:pointer;" title="Delete">
                            üóëÔ∏è
                        </button>
                    </div>
                </div>
            `;
            list.appendChild(div);
        });

        // Update Totals
        $('totMonthly').innerText = fmtMoney(mTotal, display);
        $('totYearly').innerText = fmtMoney(yTotal, display);
        $('countActive').innerText = subs.filter(s => s.active).length; // Only count active ones
        
        // Populate Dropdowns
        const curSel = $('currency').value;
        const disSel = $('displayCcy').value;
        const opts = Object.keys(fx).sort().map(c => `<option value="${c}">${c}</option>`).join('');
        $('currency').innerHTML = opts;
        $('displayCcy').innerHTML = opts;
        
        if(fx[curSel]) $('currency').value = curSel;
        if(fx[disSel]) $('displayCcy').value = disSel; else $('displayCcy').value = 'USD';

        // Render FX Grid
        const grid = $('fxGrid');
        grid.innerHTML = '';
        Object.keys(fx).forEach(ccy => {
            if(ccy === 'USD') return;
            const item = document.createElement('div');
            item.className = 'fx-item';
            item.innerHTML = `<div style="font-weight:bold; color:var(--ink);">${ccy}</div><div style="color:var(--muted); font-size:13px;">${fx[ccy].toFixed(2)}</div>`;
            grid.appendChild(item);
        });
    }

    // --- BUTTON ACTIONS ---

    $('addBtn').addEventListener('click', () => {
        const name = $('name').value;
        const cost = parseFloat($('cost').value);
        if(!name || isNaN(cost)) return alert('Please enter a valid name and cost');
        
        const newSub = {
            name, 
            cost, 
            currency: $('currency').value, 
            cycle: $('cycle').value,
            date: $('startDate').value,
            active: true
        };

        if (editIndex > -1) {
            // Update Existing
            subs[editIndex] = newSub;
            editIndex = -1; // Reset edit mode
            $('addBtn').innerText = "+ Add Subscription";
            $('addBtn').style.background = "linear-gradient(90deg, #ec4899, #06b6d4)";
        } else {
            // Create New
            subs.push(newSub);
        }

        save();
        render();
        // Clear inputs
        $('name').value = ''; $('cost').value = ''; $('startDate').value = '';
    });

    $('displayCcy').addEventListener('change', (e) => { display = e.target.value; render(); });
    $('fxUpdate').addEventListener('click', fetchLiveRates);

    // --- GLOBAL WINDOW FUNCTIONS (Called by HTML clicks) ---

    // 1. DELETE
    window.delSub = function(index) {
        if(confirm('Delete this subscription?')) {
            subs.splice(index, 1);
            if(editIndex === index) { editIndex = -1; $('addBtn').innerText = "+ Add Subscription"; }
            save();
            render();
        }
    };

    // 2. TOGGLE ACTIVE/INACTIVE
    window.toggleSub = function(index) {
        if (typeof subs[index].active === 'undefined') subs[index].active = true;
        subs[index].active = !subs[index].active; // Flip status
        save();
        render();
    };

    // 3. EDIT SUBSCRIPTION
    window.editSub = function(index) {
        const s = subs[index];
        // Fill form with data
        $('name').value = s.name;
        $('cost').value = s.cost;
        $('currency').value = s.currency;
        $('cycle').value = s.cycle;
        $('startDate').value = s.date || '';

        // Enter Edit Mode
        editIndex = index;
        const btn = $('addBtn');
        btn.innerText = "üíæ Update Subscription";
        btn.style.background = "#4ade80"; // Green color for update
        
        // Scroll to top so user sees the form
        document.getElementById('sm').scrollIntoView({ behavior: 'smooth' });
    };

    // Initial Load
    render(); 
    fetchLiveRates(); 
  })();
  </script>
</body>
</html>
