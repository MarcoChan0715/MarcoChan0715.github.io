<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>My Apps Dashboard</title>

  <link rel="stylesheet" href="Coursework.css" />
  <script src="https://kit.fontawesome.com/f65489be61.js" crossorigin="anonymous"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    /* ===== DASHBOARD STYLES ===== */
    .app-container { max-width: 1100px; margin: 0 auto; padding-top: 140px; }
    
    /* Grid for App Icons */
    .app-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 30px;
        padding: 20px;
        justify-items: center;
        animation: fadeIn 0.5s ease;
    }

    .app-icon {
        width: 140px;
        height: 140px;
        background: white;
        border-radius: 28px;
        box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
        border: 1px solid rgba(0,0,0,0.05);
        text-align: center;
        padding: 10px;
    }

    .app-icon:hover { transform: translateY(-5px); box-shadow: 0 15px 35px rgba(0,0,0,0.15); }
    .app-icon i { font-size: 40px; margin-bottom: 12px; }
    .app-name { font-weight: 600; font-size: 14px; color: #333; }
    
    /* Colors for Icons */
    .icon-sub { color: #8b5cf6; background: linear-gradient(135deg, #f5f3ff, #ede9fe); }
    .icon-clock { color: #06b6d4; background: linear-gradient(135deg, #ecfeff, #cffafe); }
    .icon-weather { color: #f59e0b; background: linear-gradient(135deg, #fffbeb, #fef3c7); }
    
    /* Dark Mode for Icons */
    body.dark-mode .app-icon { background: #1e293b; border-color: #334155; }
    body.dark-mode .app-name { color: #e2e8f0; }
    body.dark-mode .icon-sub { background: #2e1065; color: #a78bfa; }
    body.dark-mode .icon-clock { background: #083344; color: #22d3ee; }

    /* ===== APP VIEW CONTAINER ===== */
    .app-view {
        display: none; /* Hidden by default */
        animation: slideUp 0.3s ease-out;
    }
    .back-bar {
        padding: 10px 0 20px;
    }
    .back-btn {
        background: transparent; border: none; 
        font-size: 16px; font-weight: 600; 
        color: var(--muted); cursor: pointer;
        display: flex; align-items: center; gap: 8px;
        transition: color 0.2s;
    }
    .back-btn:hover { color: var(--ink); }

    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }


    /* ===== SUBSCRIPTION MANAGER STYLES (Existing) ===== */
    #sm {
      box-sizing: border-box;
      font-family: 'Poppins', sans-serif;
      width: 100%;
      padding: 24px 16px 56px;
      background: rgba(255, 255, 255, 0.95); 
      border-radius: 16px;
      transition: background 0.3s, color 0.3s;
      position: relative; 
    }
    /* Default Light Mode Variables */
    :root { --ink: #0f172a; --muted:#64748b; --card:#ffffff; --border:#e5e7eb; }
    /* GLOBAL DARK MODE OVERRIDES */
    body.dark-mode #sm {
        background: rgba(30, 30, 40, 0.95);
        --ink: #eef2ff; --muted: #94a3b8; --card: #1e293b; --border: #334155;
    }
    #sm h1 { margin: 0 0 12px; font-size: 26px; font-weight:700; color: var(--ink); }
    #sm p.sm-sub { margin:0; color: var(--muted); font-size:12px; }
    #sm .sm-top { display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap; margin:14px 0 18px; }
    #sm .sm-group { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    #sm .sm-input, #sm .sm-select {
      background: var(--card); color: var(--ink);
      border:1px solid var(--border); border-radius:12px; padding:10px 12px; font-size:14px;
      outline:none; min-height:40px; width: 100%;
    }
    #sm .sm-card { background: var(--card); border:1px solid var(--border); border-radius:16px; padding:16px; margin-bottom: 20px; box-shadow:0 8px 18px rgba(0,0,0,0.06); }
    #sm .sm-row { display:grid; grid-template-columns: repeat(12, 1fr); gap:10px; margin-top: 10px; }
    #sm .col-12 { grid-column: span 12; }
    #sm .col-6 { grid-column: span 6; }
    #sm .col-3 { grid-column: span 3; }
    #sm .sm-btn { border:1px solid var(--border); background: var(--card); color: var(--ink); border-radius:12px; padding:10px 14px; font-weight:600; cursor:pointer; }
    #sm .sm-btn.primary { background: linear-gradient(90deg, #ec4899, #06b6d4); color:#fff; border:0; }
    #sm .fx-grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap:10px; margin-bottom: 10px; }
    .modal-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0, 0, 0, 0.6); z-index: 10000;
        display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px);
    }
    .modal-box {
        background: var(--card); padding: 30px; border-radius: 20px;
        width: 90%; max-width: 500px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        border: 1px solid var(--border); animation: popUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    @keyframes popUp { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    @media (max-width: 800px) { #sm .col-6, #sm .col-3 { grid-column: span 12; } }


    /* ===== CLOCK STYLES ===== */
    .clock-container {
        text-align: center;
        background: rgba(255,255,255,0.95);
        padding: 40px; border-radius: 20px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }
    body.dark-mode .clock-container { background: #1e293b; color: white; }
    
    /* Analog Clock Face */
    #clock-face {
        width: 300px; height: 300px;
        background: url('images/clockface.png');
        background-size: cover;
        margin: 0 auto 30px;
        position: relative;
        border-radius: 50%;
        box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    }
    #clock-face::after {
        content:''; position: absolute; width: 15px; height: 15px; background: #333;
        top: 50%; left: 50%; transform: translate(-50%, -50%); border-radius: 50%; z-index: 10;
    }
    #hour, #min, #sec { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-size: cover; }
    #hour { background-image: url('images/hourhand.png'); z-index: 3; }
    #min { background-image: url('images/minhand.png'); z-index: 4; }
    #sec { background-image: url('images/secondshand.png'); z-index: 5; }

    /* Digital Time & Stopwatch */
    .digital-time { font-size: 40px; font-weight: bold; margin: 10px 0; font-family: monospace; }
    .date-display { font-size: 18px; opacity: 0.7; margin-bottom: 20px; }
    .stopwatch-display { font-size: 50px; font-family: monospace; color: #009688; margin: 20px 0; }
    .sw-btn { 
        padding: 10px 20px; margin: 0 5px; cursor: pointer; border-radius: 8px; border: none; font-weight: bold; font-size: 14px;
    }

  </style>
</head>
<body>

  <div class="header-container">
     <a href="index.html">
        <img src="images/Coursework/Untitled_Artwork.png" class="logo" alt="Logo">
     </a>
     <div class="navbar">
      <ul>
        <li><a href="index.html">Home</a></li>
        <li><a href="Hobbies.html">Hobbies</a></li>
        <li><a href="Video.html">Video</a></li>
        <li><a href="app.html" class="active">Apps</a></li> 
        <li><a href="Clock.html">Clock</a></li>
      </ul>
     </div>
  </div>

  <div class="app-container">
      
      <div id="dashboardView">
          <h1 style="text-align:center; margin-bottom:10px;">My Apps</h1>
          <p style="text-align:center; color:var(--muted); margin-bottom:30px;">Select an app to launch</p>
          
          <div class="app-grid">
              <div class="app-icon icon-sub" onclick="openApp('subManager')">
                  <i class="fa-solid fa-receipt"></i>
                  <div class="app-name">Subscriptions</div>
              </div>

              <div class="app-icon icon-clock" onclick="openApp('clockApp')">
                  <i class="fa-solid fa-clock"></i>
                  <div class="app-name">Clock</div>
              </div>

              <div class="app-icon icon-weather" style="opacity:0.6; cursor:default;" title="Coming Soon">
                  <i class="fa-solid fa-cloud-sun"></i>
                  <div class="app-name">Weather</div>
              </div>
          </div>
      </div>

      <div id="subManager" class="app-view">
          <div class="back-bar">
              <button class="back-btn" onclick="closeApp()"><i class="fa-solid fa-arrow-left"></i> Back to Home</button>
          </div>
          
          <div id="sm">
              <div class="sm-top">
                <div style="text-align: left;">
                  <h1>Subscription Manager</h1>
                  <p class="sm-sub">Track your recurring payments easily.</p>
                </div>
                <div class="sm-group">
                  <label class="sm-label" style="font-size: 12px; color: var(--muted)">Sort:</label>
                  <select id="sortOrder" class="sm-select" style="width:auto; margin-right: 15px;">
                     <option value="date">Next Bill Date</option>
                     <option value="priceDesc">Price (High to Low)</option>
                     <option value="priceAsc">Price (Low to High)</option>
                     <option value="name">Name (A-Z)</option>
                  </select>
                  <label class="sm-label" style="font-size: 12px; color: var(--muted)">Currency:</label>
                  <select id="displayCcy" class="sm-select" style="width:auto;"></select>
                </div>
              </div>
              
              <div class="sm-card" style="display:flex; gap:20px; justify-content: space-around; text-align: center;">
                <div>
                    <div style="font-size:12px; color:var(--muted);">Monthly Total</div>
                    <div id="totMonthly" style="font-size:24px; font-weight:700; color:var(--ink);">$0.00</div>
                </div>
                <div>
                    <div style="font-size:12px; color:var(--muted);">Yearly Total</div>
                    <div id="totYearly" style="font-size:24px; font-weight:700; color:var(--ink);">$0.00</div>
                </div>
              </div>

              <section id="upcomingSection" class="sm-card" style="display:none; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border:none;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div style="text-align: left;">
                        <div style="font-size:12px; opacity:0.9; text-transform:uppercase; letter-spacing:1px; margin-bottom:5px;">Upcoming Payment</div>
                        <h2 id="upName" style="margin:0; font-size:22px; color:white;">Netflix</h2>
                        <div id="upDate" style="font-size:13px; opacity:0.9; margin-top:4px;">Due on 12/01/2026</div>
                    </div>
                    <div style="text-align:right;">
                        <div id="upCost" style="font-size:26px; font-weight:700;">$13.00</div>
                        <div id="upCountdown" style="font-size:12px; background:rgba(255,255,255,0.25); padding:4px 10px; border-radius:20px; display:inline-block; margin-top:5px; font-weight:600;">In 5 days</div>
                    </div>
                </div>
              </section>

              <section class="sm-card">
                <h3 style="color:var(--ink)">Add Subscription</h3>
                <div class="sm-row">
                  <div class="col-6"><input id="name" class="sm-input" placeholder="Name (e.g. Netflix)" /></div>
                  <div class="col-3"><input id="cost" type="number" class="sm-input" placeholder="Price" /></div>
                  <div class="col-3"><select id="currency" class="sm-select"></select></div>
                  <div class="col-6">
                    <select id="cycle" class="sm-select">
                      <option value="monthly">Monthly (Same Date)</option>
                      <option value="days30">Every 30 Days</option>
                      <option value="yearly">Yearly</option>
                    </select>
                  </div>
                   <div class="col-6"><input id="startDate" type="date" class="sm-input" /></div>
                </div>
                <button id="addBtn" class="sm-btn primary" style="margin-top: 15px; width: 100%;">+ Add Subscription</button>
              </section>

              <section class="sm-card">
                <h3 style="color:var(--ink)">Active Subscriptions (<span id="countActive">0</span>)</h3>
                <div id="activeList"></div>
              </section>

              <section class="sm-card" id="inactiveSection" style="display:none; border: 1px dashed var(--border); background: rgba(128,128,128,0.02);">
                <h3 style="color:var(--muted)">Inactive Subscriptions (<span id="countInactive">0</span>)</h3>
                <div id="inactiveList"></div>
              </section>
              
              <section class="sm-card">
                <h3 style="color:var(--ink)">FX Rates</h3>
                 <div id="fxGrid" class="fx-grid"></div>
                 <button id="fxUpdate" class="sm-btn">Update Rates</button>
              </section>

              <div id="editModal" class="modal-overlay">
                <div class="modal-box">
                    <h2 style="color:var(--ink); margin-top:0;">Edit Subscription</h2>
                    <div class="sm-row">
                        <div class="col-12"><label style="font-size:12px; color:var(--muted);">Name</label><input id="editName" class="sm-input" /></div>
                        <div class="col-6"><label style="font-size:12px; color:var(--muted);">Price</label><input id="editCost" type="number" class="sm-input" /></div>
                        <div class="col-6"><label style="font-size:12px; color:var(--muted);">Currency</label><select id="editCurrency" class="sm-select"></select></div>
                        <div class="col-6"><label style="font-size:12px; color:var(--muted);">Cycle</label><select id="editCycle" class="sm-select"><option value="monthly">Monthly</option><option value="yearly">Yearly</option><option value="days30">Every 30 Days</option></select></div>
                        <div class="col-6"><label style="font-size:12px; color:var(--muted);">Start Date</label><input id="editDate" type="date" class="sm-input" /></div>
                    </div>
                    <div style="margin-top:25px; display:flex; gap:10px; justify-content:flex-end;">
                        <button onclick="window.closeEditModal()" class="sm-btn" style="background:transparent;">Cancel</button>
                        <button onclick="window.saveEdit()" class="sm-btn primary" style="background:#4ade80;">Save Changes</button>
                    </div>
                </div>
              </div>
          </div>
      </div>

      <div id="clockApp" class="app-view">
           <div class="back-bar">
              <button class="back-btn" onclick="closeApp()"><i class="fa-solid fa-arrow-left"></i> Back to Home</button>
          </div>
          <div class="clock-container">
              <h2>Analog Clock</h2>
              <div id="clock-face">
                <div id="sec"></div>
                <div id="min"></div>
                <div id="hour"></div>
              </div>

              <h2>Digital Clock</h2>
              <div class="digital-time" id="digitalTime">--:--:--</div>
              <div class="date-display" id="dateDisplay">--/--/----</div>

              <hr style="margin: 30px 0; border:0; border-top:1px solid #eee;">
              
              <h2 style="color:#009688;">Stopwatch</h2>
              <div class="stopwatch-display" id="swDisplay">00:00:00</div>
              <div>
                  <button class="sw-btn" style="background:#fecaca; color:#ef4444;" onclick="Stop()">Stop</button>
                  <button class="sw-btn" style="background:#bbf7d0; color:#16a34a;" onclick="Start()">Start</button>
                  <button class="sw-btn" style="background:#e5e7eb; color:#374151;" onclick="Reset()">Reset</button>
              </div>
          </div>
      </div>

  </div>

  <script src="Coursework.js"></script>

  <script>
    // === APP LAUNCHER LOGIC ===
    function openApp(appId) {
        // Hide Dashboard
        document.getElementById('dashboardView').style.display = 'none';
        // Show App
        document.getElementById(appId).style.display = 'block';
    }

    function closeApp() {
        // Hide all apps
        const apps = document.querySelectorAll('.app-view');
        apps.forEach(app => app.style.display = 'none');
        // Show Dashboard
        document.getElementById('dashboardView').style.display = 'block';
    }

    // === CLOCK LOGIC (Merged here) ===
    function updateClock() {
        const now = new Date();
        const s = now.getSeconds();
        const m = now.getMinutes();
        const h = now.getHours();
        
        // Analog Rotation
        const sDeg = s * 6;
        const mDeg = m * 6 + (s/10);
        const hDeg = h * 30 + (m/2);
        
        document.getElementById('sec').style.transform = `rotate(${sDeg}deg)`;
        document.getElementById('min').style.transform = `rotate(${mDeg}deg)`;
        document.getElementById('hour').style.transform = `rotate(${hDeg}deg)`;

        // Digital Display
        document.getElementById('digitalTime').textContent = now.toLocaleTimeString();
        
        // Date
        const day = String(now.getDate()).padStart(2, '0');
        const mo = String(now.getMonth()+1).padStart(2,'0');
        const yr = now.getFullYear();
        document.getElementById('dateDisplay').textContent = `${day}/${mo}/${yr}`;
    }
    setInterval(updateClock, 1000);
    updateClock(); // Run immediately

    // Stopwatch Logic
    let timer = null;
    let swSec = 0, swMin = 0, swHour = 0;

    function Start() {
        if(timer !== null) return;
        timer = setInterval(swUpdate, 1000);
    }
    function Stop() {
        clearInterval(timer); timer = null;
    }
    function Reset() {
        Stop(); swSec=0; swMin=0; swHour=0;
        document.getElementById('swDisplay').textContent = "00:00:00";
    }
    function swUpdate() {
        swSec++;
        if(swSec === 60) { swSec=0; swMin++; }
        if(swMin === 60) { swMin=0; swHour++; }
        
        const h = swHour < 10 ? "0"+swHour : swHour;
        const m = swMin < 10 ? "0"+swMin : swMin;
        const s = swSec < 10 ? "0"+swSec : swSec;
        document.getElementById('swDisplay').textContent = `${h}:${m}:${s}`;
    }

    // === SUBSCRIPTION MANAGER LOGIC (Wrapped) ===
    (function(){
        const $ = (id) => document.getElementById(id);
        const K_SUBS = 'sm:subs:v2';
        const K_CURRENCY = 'sm:display_currency';
        const K_SORT = 'sm:sort_order';
        
        let DEFAULT_FX = { USD:1, GBP:0.77, EUR:0.92, HKD:7.8, JPY:157, CAD:1.36, AUD:1.52, CNY:7.23 };
        
        let subs = JSON.parse(localStorage.getItem(K_SUBS) || '[]');
        let display = localStorage.getItem(K_CURRENCY) || 'USD';
        let currentSort = localStorage.getItem(K_SORT) || 'date';
        
        let fx = DEFAULT_FX;
        let editIndex = -1;

        function save(){ localStorage.setItem(K_SUBS, JSON.stringify(subs)); }
        
        function fmtMoney(n, ccy){ 
            return new Intl.NumberFormat('en-US', { style: 'currency', currency: ccy }).format(n);
        }

        function convert(amount, src, dest){ 
            const s = fx[src] || 1; 
            const d = fx[dest] || 1; 
            return (amount / s) * d; 
        }

        function getNextBillDate(startDate, cycle) {
            if (!startDate) return null; 
            let due = new Date(startDate);
            const today = new Date();
            today.setHours(0,0,0,0); 
            if (due >= today) return due.toLocaleDateString();
            while (due < today) {
                if (cycle === 'monthly') due.setMonth(due.getMonth() + 1);
                else if (cycle === 'days30') due.setDate(due.getDate() + 30);
                else due.setFullYear(due.getFullYear() + 1);
            }
            return due.toLocaleDateString();
        }

        function getNextBillTimestamp(startDate, cycle) {
            if (!startDate) return 9999999999999; 
            let due = new Date(startDate);
            const today = new Date();
            today.setHours(0,0,0,0); 
            if (due >= today) return due.getTime();
            while (due < today) {
                if (cycle === 'monthly') due.setMonth(due.getMonth() + 1);
                else if (cycle === 'days30') due.setDate(due.getDate() + 30);
                else due.setFullYear(due.getFullYear() + 1);
            }
            return due.getTime();
        }

        async function fetchLiveRates() {
            const btn = $('fxUpdate');
            const originalText = btn.textContent;
            btn.textContent = "Fetching...";
            btn.disabled = true;
            try {
                const response = await fetch('https://api.frankfurter.app/latest?from=USD');
                if (!response.ok) throw new Error("API Connection Failed");
                const data = await response.json();
                fx = { USD: 1, ...data.rates };
                render(); 
                btn.textContent = "Rates Updated!";
            } catch (error) {
                console.error(error);
                alert("Using offline rates.");
                fx = DEFAULT_FX;
                render();
                btn.textContent = "Update Failed";
            } finally {
                setTimeout(() => { btn.textContent = originalText; btn.disabled = false; }, 2000);
            }
        }

        function render(){
            // Upcoming Payment
            let nearestSub = null;
            let minTime = 9999999999000;
            subs.forEach(s => {
                if(s.active && s.date) {
                    let ts = getNextBillTimestamp(s.date, s.cycle);
                    if(ts < minTime) { minTime = ts; nearestSub = s; }
                }
            });
            const upSec = $('upcomingSection');
            if(nearestSub) {
                upSec.style.display = 'block';
                $('upName').textContent = nearestSub.name;
                $('upCost').textContent = fmtMoney(nearestSub.cost, nearestSub.currency);
                let dateObj = new Date(minTime);
                $('upDate').textContent = "Due on " + dateObj.toLocaleDateString();
                let now = new Date(); now.setHours(0,0,0,0);
                let diffTime = dateObj - now;
                let diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                let dayText = "";
                if(diffDays === 0) dayText = "Today!"; else if(diffDays === 1) dayText = "Tomorrow"; else dayText = `In ${diffDays} days`;
                $('upCountdown').textContent = dayText;
            } else { upSec.style.display = 'none'; }

            // Sort
            subs.sort((a, b) => {
                if (currentSort === 'name') return a.name.localeCompare(b.name);
                else if (currentSort === 'priceDesc') return convert(b.cost, b.currency, 'USD') - convert(a.cost, a.currency, 'USD');
                else if (currentSort === 'priceAsc') return convert(a.cost, a.currency, 'USD') - convert(b.cost, b.currency, 'USD');
                else return getNextBillTimestamp(a.date, a.cycle) - getNextBillTimestamp(b.date, b.cycle);
            });

            const activeList = $('activeList');
            const inactiveList = $('inactiveList');
            activeList.innerHTML = ''; inactiveList.innerHTML = '';
            let mTotal = 0; let yTotal = 0; let actCount = 0; let inactCount = 0;

            subs.forEach((s, index) => {
                if (typeof s.active === 'undefined') s.active = true;
                const val = convert(s.cost, s.currency, display);
                if (s.active) {
                    actCount++;
                    if(s.cycle === 'monthly') { mTotal += val; yTotal += val * 12; }
                    else if(s.cycle === 'days30') { let occ = 365/30; mTotal += (val*occ)/12; yTotal += val*occ; }
                    else { mTotal += val / 12; yTotal += val; }
                } else { inactCount++; }

                const nextDate = getNextBillDate(s.date, s.cycle);
                const dateHTML = nextDate ? `<div style="font-size:11px; color:#eab308; display:flex; align-items:center; gap:4px;">Next Bill: ${nextDate}</div>` : '';
                let cycleText = 'PAUSED';
                if (s.active) {
                    if(s.cycle === 'monthly') cycleText = 'monthly';
                    else if(s.cycle === 'days30') cycleText = '30 DAYS';
                    else cycleText = 'yearly';
                }

                const div = document.createElement('div');
                const bg = s.active ? "transparent" : "rgba(128, 128, 128, 0.05)";
                div.style.cssText = `display:flex; justify-content:space-between; padding: 12px; border-bottom:1px solid var(--border); color: var(--ink); align-items: center; background:${bg};`;
                
                div.innerHTML = `
                    <div style="display:flex; flex-direction:column; align-items:flex-start; gap:2px;">
                        <div style="display:flex; align-items:center; gap:6px; flex-wrap:wrap;">
                            <strong style="font-size:16px;">${s.name}</strong> 
                            <span style="font-size:11px; background:${s.active ? '#e0f2fe' : '#ddd'}; color:${s.active ? '#0284c7' : '#666'}; padding:2px 6px; border-radius:4px; font-weight:600;">${cycleText}</span>
                        </div>
                        ${s.active ? dateHTML : ''} 
                    </div>
                    <div style="text-align:right; display:flex; flex-direction:column; align-items:flex-end; gap:5px;">
                        <div style="font-weight:bold; font-size:16px;">${fmtMoney(s.cost, s.currency)}</div>
                        <div style="display:flex; gap:8px;">
                            <button onclick="window.toggleSub(${index})" style="font-size:12px; border:1px solid var(--border); background:var(--card); color:var(--ink); padding:5px 10px; border-radius:6px; cursor:pointer; min-width: 65px;">${s.active ? 'Pause' : 'Resume'}</button>
                            <button onclick="window.openEditModal(${index})" style="font-size:12px; border:1px solid var(--border); background:var(--card); color:var(--ink); padding:5px 10px; border-radius:6px; cursor:pointer;">Edit</button>
                            <button onclick="window.delSub(${index})" style="font-size:12px; border:1px solid #fee2e2; background:#fef2f2; color:#ef4444; padding:5px 10px; border-radius:6px; cursor:pointer;">Delete</button>
                        </div>
                    </div>
                `;
                if (s.active) activeList.appendChild(div); else inactiveList.appendChild(div);
            });

            $('totMonthly').innerText = fmtMoney(mTotal, display);
            $('totYearly').innerText = fmtMoney(yTotal, display);
            $('countActive').innerText = actCount;
            $('countInactive').innerText = inactCount;
            const inactSec = $('inactiveSection');
            inactSec.style.display = (inactCount === 0) ? 'none' : 'block';
            
            const opts = Object.keys(fx).sort().map(c => `<option value="${c}">${c}</option>`).join('');
            $('currency').innerHTML = opts; $('displayCcy').innerHTML = opts; $('editCurrency').innerHTML = opts; 
            $('displayCcy').value = display; $('sortOrder').value = currentSort;
            
            const grid = $('fxGrid'); grid.innerHTML = '';
            Object.keys(fx).forEach(ccy => {
                if(ccy === 'USD') return;
                const item = document.createElement('div'); item.className = 'fx-item';
                item.innerHTML = `<div style="font-weight:bold; color:var(--ink);">${ccy}</div><div style="color:var(--muted); font-size:13px;">${fx[ccy].toFixed(2)}</div>`;
                grid.appendChild(item);
            });
        }

        $('addBtn').addEventListener('click', () => {
            const name = $('name').value;
            const cost = parseFloat($('cost').value);
            if(!name || isNaN(cost)) return alert('Please enter a valid name and cost');
            subs.push({ name, cost, currency: $('currency').value, cycle: $('cycle').value, date: $('startDate').value, active: true });
            save(); render();
            $('name').value = ''; $('cost').value = ''; $('startDate').value = '';
        });

        $('displayCcy').addEventListener('change', (e) => { display = e.target.value; localStorage.setItem(K_CURRENCY, display); render(); });
        $('sortOrder').addEventListener('change', (e) => { currentSort = e.target.value; localStorage.setItem(K_SORT, currentSort); render(); });
        $('fxUpdate').addEventListener('click', fetchLiveRates);

        window.delSub = function(index) { if(confirm('Delete?')) { subs.splice(index, 1); save(); render(); if(editIndex===index) window.closeEditModal(); }};
        window.toggleSub = function(index) { if (typeof subs[index].active === 'undefined') subs[index].active = true; subs[index].active = !subs[index].active; save(); render(); };
        window.openEditModal = function(index) {
            const s = subs[index];
            $('editName').value = s.name; $('editCost').value = s.cost; $('editCurrency').value = s.currency; $('editCycle').value = s.cycle; $('editDate').value = s.date || '';
            editIndex = index; $('editModal').style.display = 'flex'; 
        };
        window.closeEditModal = function() { $('editModal').style.display = 'none'; editIndex = -1; };
        window.saveEdit = function() {
            if(editIndex === -1) return;
            const name = $('editName').value; const cost = parseFloat($('editCost').value);
            if(!name || isNaN(cost)) return alert('Name and Price are required');
            subs[editIndex].name = name; subs[editIndex].cost = cost; subs[editIndex].currency = $('editCurrency').value; subs[editIndex].cycle = $('editCycle').value; subs[editIndex].date = $('editDate').value;
            save(); render(); window.closeEditModal();
        };

        render(); fetchLiveRates(); 
    })();
  </script>
</body>
</html>
